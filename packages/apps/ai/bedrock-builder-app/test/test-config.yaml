# List of admin roles which will be provided access to agent resources (like KMS/Bucket)
dataAdminRoles:
  - name: 'Admin'

# (Optional) List of Lambda functions. 
# Agent will be able to invoke these functions based on the action group(s). 
# Knowledgebase may be able to use lambda function for custom transformations
# Lambda function will hold the business logic. Bedrock agent will pass necessary parameters
 
lambdaFunctions:
  # List of Lambda layers to create
  layers:
    - layerName: test-layer
      src: ./src/layer/
      description: 'test layer'

  # List of functions definitions as produced by 'aws glue get-functions --name <name> --include-graph'
  functions:
    - functionName: test-action-group
      description: "This is lambda function for Bedrock Agent Action group: test-agent/test-action-group"
      srcDir: ./src/function
      handler: test.lambda_handler
      runtime: python3.13
      roleArn: 'arn:test-partition:iam::test-acct:role/test-lambda-role'
    - functionName: test-custom-transformer
      srcDir: ./src/function
      handler: test.lambda_handler
      runtime: python3.13
      roleArn: 'arn:test-partition:iam::test-acct:role/test-lambda-role'
      description: For custom parsing and chunking logic
      # Refer https://docs.aws.amazon.com/bedrock/latest/userguide/kb-custom-transformation.html for details of how this lambda works.
    - functionName: test-custom-router1
      srcDir: ./src/function
      handler: test.lambda_handler
      runtime: python3.13
      roleArn: 'arn:test-partition:iam::test-acct:role/test-lambda-role'
      description: For custom chat routing logic
      grantInvoke: "arn:aws:iam::123456789012:role/role-in-another-account"
    - functionName: test-custom-router2
      srcDir: ./src/function
      handler: test.lambda_handler
      runtime: python3.13
      roleArn: 'arn:test-partition:iam::test-acct:role/test-lambda-role'
      description: For custom chat routing logic
      grantInvoke: "arn:aws:iam::123456789012:role/role-in-another-account"
      additionalResourcePermissions:
        crossAccountInvoke:
          principal: "arn:aws:iam::123456789012:role/role-in-another-account"
          action: lambda:InvokeFunction
        crossAccountInvoke2:
          principal: "arn:aws:iam::123456789012:role/role-in-another-account"
          action: lambda:InvokeFunction

# Bedrock Agent Configuration
agents:
  test-agent:
    agentAliasName: test-alias
    role:
      id: generated-role-id:agent-execution-role
    foundationModel: 'anthropic.claude-3-sonnet-20240229-v1:0'

    # (Optional parameters)
    description: 'This is a Test Agent'
    autoPrepare: true # Default: false
    instruction: |
      You are a helpful assistant
      You are allowed to use associated Knowledge Base to answer questions
      Provide responses in markdown format with source citations
    idleSessionTtlInSeconds: 400
    #(Optional Knowledgebae)
    knowledgeBases:
      - description: "This is a Test Knowledge Base"
        id: "<kb-id>"
    #(Optional Guardrail)
    guardrail:
      id: 'arn:aws:bedrock:{{region}}:{{account}}:guardrail/test-guardrail√ü'
      version: '1'
    actionGroups:
      - actionGroupName: "test-action-group"
        description: "This is a Test Action Group"
        actionGroupExecutor:
          # Option 1: Provide ARN of an existing Lambda
          # Option 2: Provide reference to Lambda function which will be generated via Configuration. refer them by generatedFunction:<function-name>
          lambda: arn:aws:lambda:{{region}}:{{account}}:function:existing-lambda-function # OR generated-function:test-agent-lambda
        apiSchema: 
          # (Optional) 
          # 1. 'payload': Provide JSON/YAML formatted payload defining the OpenAPI schema for Action Group
          # 2. 'openApiSchemaPath': (local) relative path to YAML file
          # 3. OR 's3': Provide details about s3 object containing OpenAPI schema for Action Group
          openApiSchemaPath: ./api-schema/test-schema.yaml

vectorStores:
  test-vector-store:
    vpcId: test-vpc-id
    subnetIds:
      - 'test-subnet-id1'
      - 'test-subnet-id2'
    # (Optional) min and max Aurora Serverless Capacity Units
    minCapacity: 1
    maxCapacity: 8

# Knowledge Base Configuration
knowledgeBases:
  test-knowledge-base:
    embeddingModel: 'arn:aws:bedrock::aws:foundation-model/amazon.titan-embed-text-v1'
    vectorStore: test-vector-store
    vectorFieldSize: 1536
    role:
      id: generated-role-id:kb-execution-role
    # For Multimodal documents, its mandatory to provide location to store the images extracted from your data source
    supplementalBucketName: 'supplemental-image-storage-bucket'
    s3DataSources:
      test-ds-default-parsing:
        bucketName: 'customer-docs-bucket'
        prefix: 'support-documents/'
        enableSync: true 

      test-ds-bda-parsing:
        bucketName: 'customer-docs-bucket'
        prefix: 'support-documents-2/'
        vectorIngestionConfiguration:
          parsingConfiguration:
            parsingStrategy: 'BEDROCK_DATA_AUTOMATION'
            bedrockDataAutomationConfiguration:
              parsingModality: 'MULTIMODAL'
          # (Optional) Allows customized chunking strategy for the data source.
          # The chunking strategy cannot be modified after a data source has been created
          chunkingConfiguration:
            chunkingStrategy: 'FIXED_SIZE'
            fixedSizeChunkingConfiguration:
              maxTokens: 512
              overlapPercentage: 20
              
      test-ds-foundation-model-parsing:
        bucketName: 'customer-docs-bucket'
        prefix: 'support-documents-3/'
        vectorIngestionConfiguration:
          parsingConfiguration:
            parsingStrategy: 'BEDROCK_FOUNDATION_MODEL'
            bedrockFoundationModelConfiguration:
              modelArn: 'anthropic.claude-3-sonnet-20240229-v1:0'
              parsingModality: 'MULTIMODAL'
              parsingPromptText: 'Extract key information from this document'

      test-ds-custom-parsing:
        bucketName: 'customer-docs-bucket'
        prefix: 'support-documents-4/'
        vectorIngestionConfiguration:
          parsingConfiguration:
            parsingStrategy: 'BEDROCK_DATA_AUTOMATION'
            bedrockDataAutomationConfiguration:
              parsingModality: 'MULTIMODAL'
          chunkingConfiguration:
            chunkingStrategy: 'NONE'
          # (Optional) Allows providing a lambda function to perform custom transformations on data being ingested into the Knowledgebase.
          # # Refer https://docs.aws.amazon.com/bedrock/latest/userguide/kb-custom-transformation.html for details of how this lambda works.
          customTransformationConfiguration:
            intermediateStorageBucket: 'custom-transform-intermediate-bucket'
            intermediateStoragePrefix: 'path/to/data/objects'
            transformLambdaArns:
              # Refer https://docs.aws.amazon.com/bedrock/latest/userguide/kb-custom-transformation.html for details of how this lambda works.
              - 'arn:aws:lambda:{{region}}:{{account}}:function:test-custom-transformer'
              - generated-function:test-custom-transformer

# Guardrails Configuration
guardrails:
  enterprise-guardrail:
    description: 'Enterprise content safety guardrail'
    contentFilters:
      hate:
        inputStrength: 'MEDIUM'
        outputStrength: 'MEDIUM'
    blockedInputMessaging: 'Your input contains restricted content'
    blockedOutputsMessaging: 'Response blocked due to policy restrictions'

    contextualGroundingFilters:
      grounding: 0.95
      relevance: 0.90
